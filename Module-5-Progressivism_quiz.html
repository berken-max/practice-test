<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>iPhone Practice Test</title>
<style>
  :root {
    --bg: #0f172a;
    --card: #111827;
    --ink: #e5e7eb;
    --muted: #9ca3af;
    --accent: #22c55e;
    --warn: #ef4444;
    --btn: #1f2937;
    --border: #374151;
  }
  html, body {
    margin: 0;
    padding: 0;
    background: var(--bg);
    color: var(--ink);
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  .wrap {
    max-width: 720px;
    margin: 0 auto;
    padding: 12px;
  }
  header {
    position: sticky;
    top: 0;
    z-index: 10;
    background: linear-gradient(180deg, rgba(15,23,42,0.95) 70%, rgba(15,23,42,0));
    backdrop-filter: blur(6px);
    padding: 10px 12px 8px;
    border-bottom: 1px solid var(--border);
  }
  h1 {
    margin: 0;
    font-size: 20px;
    letter-spacing: 0.2px;
  }
  .mode-toggle {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 8px;
  }
  .btn {
    appearance: none;
    border: 1px solid var(--border);
    background: var(--btn);
    color: var(--ink);
    border-radius: 14px;
    padding: 12px 14px;
    font-size: 16px;
    font-weight: 600;
    width: 100%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: transform 0.02s ease, background 0.2s ease, border-color 0.2s ease;
  }
  .btn:active { transform: scale(0.98); }
  .btn.primary { background: #2563eb; border-color: #1d4ed8; }
  .btn.accent { background: #16a34a; border-color: #15803d; }
  .btn.warn { background: #b91c1c; border-color: #991b1b; }
  .btn.ghost { background: transparent; }
  .btn:disabled { opacity: 0.5; }
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 18px;
    padding: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
  }
  .controls {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin: 12px 0;
  }
  .meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin: 10px 0 4px;
    font-size: 14px;
    color: var(--muted);
  }
  .progress {
    height: 10px;
    background: #0b1220;
    border: 1px solid var(--border);
    border-radius: 999px;
    overflow: hidden;
  }
  .bar { height: 100%; width: 0%; background: #22c55e; transition: width 0.3s ease; }
  .q {
    margin-top: 6px;
    font-size: 18px;
    line-height: 1.4;
  }
  .answers {
    margin-top: 10px;
    display: grid;
    gap: 8px;
  }
  .choice {
    border: 1px solid var(--border);
    background: #0b1220;
    border-radius: 14px;
    padding: 12px;
    font-size: 16px;
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 10px;
    align-items: start;
  }
  .choice input { margin-top: 2px; }
  .feedback {
    margin-top: 10px;
    padding: 10px;
    border-radius: 12px;
    background: #0b1220;
    border: 1px solid var(--border);
    font-size: 15px;
  }
  .ok { color: var(--accent); font-weight: 700; }
  .bad { color: var(--warn); font-weight: 700; }
  .footer {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 12px;
  }
  .summary {
    margin-top: 12px;
    display: none;
  }
  .summary h2 { font-size: 18px; margin: 8px 0; }
  .missed {
    display: grid;
    gap: 10px;
  }
  .missed .card { border-left: 4px solid var(--warn); }
  .download-wrap { margin-top: 8px; text-align: right; }
  .select {
    width: 100%;
    background: #0b1220;
    color: var(--ink);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 10px 12px;
    font-size: 16px;
  }
  .tiny { font-size: 12px; color: var(--muted); }
  .pill {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: #0b1220;
    font-size: 12px;
    color: var(--muted);
  }
</style>
</head>
<body>
<header class="wrap">
  <h1>Practice Test</h1>
  <div class="mode-toggle">
    <button id="studyBtn" class="btn">Study Mode</button>
    <button id="testBtn" class="btn primary">Test Mode</button>
  </div>
  <div class="controls">
    <select id="countSelect" class="select" title="Question count">
      <option value="10">10 questions</option>
      <option value="20">20 questions</option>
      <option value="30">30 questions</option>
      <option value="40">40 questions</option>
      <option value="50" selected>50 questions</option>
    </select>
    <button id="startBtn" class="btn accent">Start</button>
  </div>
  <div class="download-wrap">
    <button id="downloadBtn" class="btn ghost">Download this file</button>
  </div>
</header>

<main class="wrap">
  <div id="quiz" class="card">
    <div class="meta">
      <div><span class="pill" id="modePill">Test Mode</span></div>
      <div id="progressText">0/0</div>
    </div>
    <div class="progress"><div class="bar" id="bar"></div></div>
    <div id="qText" class="q">Tap Start to begin.</div>
    <div id="answers" class="answers"></div>
    <div id="feedback" class="feedback" style="display:none;"></div>
    <div class="footer">
      <button id="prevBtn" class="btn" disabled>◀︎ Prev</button>
      <button id="nextBtn" class="btn">Next ▶︎</button>
    </div>
    <div class="tiny" style="margin-top:8px;">Answers and question order are shuffled each run.</div>
  </div>

  <section id="summary" class="summary">
    <div class="card">
      <h2>Summary</h2>
      <p id="scoreLine"></p>
      <div id="missedWrap" style="display:none;">
        <h3>Review missed questions</h3>
        <div id="missedList" class="missed"></div>
      </div>
      <div style="margin-top:10px; display:grid; gap:8px; grid-template-columns: 1fr 1fr;">
        <button id="retryBtn" class="btn accent">Retry with new shuffle</button>
        <button id="studyFromMissedBtn" class="btn">Study Missed Only</button>
      </div>
    </div>
  </section>
</main>

<script>
/** UTILITIES **/
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
function el(id) { return document.getElementById(id); }
function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

/** QUESTION BANK
 * Replace these placeholder questions with ones generated from your notes.
 * Supported types:
 * - type: "mc", fields: prompt, options: [..], answerIndex
 * - type: "tf", fields: prompt, answer (true/false), options auto: ["True","False"]
 */
const QUESTION_BANK = [
  { type: "mc", prompt: "The Progressive Movement emerged mainly between which years, according to the notes?", options: ["1865\u20131890", "1900\u2013WWI (1914)", "1920\u20131932", "1898\u20131902"], answerIndex: 1 },
  { type: "mc", prompt: "Which statement best summarizes the Progressive Movement's aim?", options: ["Expand American territory overseas", "Restore economic opportunities and correct injustices in American life", "Reduce immigration to protect jobs", "End all government regulation"], answerIndex: 1 },
  { type: "mc", prompt: "Which is NOT one of the four goals of Progressivism listed?", options: ["Protecting social welfare", "Promoting moral improvement", "Creating economic reform", "Expanding imperialism"], answerIndex: 3 },
  { type: "tf", prompt: "One goal of Progressivism was fostering efficiency in business and government.", answer: true },
  { type: "mc", prompt: "Which organization opened libraries, sponsored classes, and built pools and handball courts?", options: ["NAACP", "YMCA", "WCTU", "AFL"], answerIndex: 1 },
  { type: "mc", prompt: "Which group fed the poor in soup kitchens and sent 'slum brigades' to teach temperance?", options: ["Salvation Army", "Boy Scouts", "Hull House", "Red Cross"], answerIndex: 0 },
  { type: "mc", prompt: "Florence Kelley was known for advocating for which group?", options: ["Railroad owners", "Women and children", "Wealthy industrialists", "Immigrant men only"], answerIndex: 1 },
  { type: "mc", prompt: "Which 1893 act did Florence Kelley help pass in Illinois?", options: ["Sherman Antitrust Act", "Keating\u2013Owen Act", "Illinois Factory Act", "Elkins Act"], answerIndex: 2 },
  { type: "tf", prompt: "The National Child Labor Committee pushed for child labor laws across many states.", answer: true },
  { type: "mc", prompt: "Prohibition refers to the ______.", options: ["Banning of alcoholic beverages", "Censorship of newspapers", "End of child labor", "Outlawing of strikes"], answerIndex: 0 },
  { type: "mc", prompt: "Which organization, founded in 1874 in Cleveland, led the crusade for prohibition?", options: ["AFL", "WCTU (Women\u2019s Christian Temperance Union)", "NAWSA", "NACW"], answerIndex: 1 },
  { type: "mc", prompt: "Who made the WCTU a national organization in 1879?", options: ["Carrie Chapman Catt", "Frances Willard", "Ida B. Wells", "Susan B. Anthony"], answerIndex: 1 },
  { type: "mc", prompt: "Which quietly founded group pushed laws to punish those who drank?", options: ["Anti\u2011Saloon League", "YMCA", "Sierra Club", "Progressive Party"], answerIndex: 0 },
  { type: "mc", prompt: "Which amendment established national prohibition?", options: ["16th", "17th", "18th", "19th"], answerIndex: 2 },
  { type: "tf", prompt: "Between 1900 and 1917, voters in nearly half the states prohibited the sale, production, and use of alcohol.", answer: true },
  { type: "mc", prompt: "Journalists who exposed corruption in business and public life were called ______.", options: ["Yellow journalists", "Muckrakers", "Booster writers", "Realists"], answerIndex: 1 },
  { type: "mc", prompt: "Which muckraker wrote about urban slums?", options: ["Jacob Riis", "Upton Sinclair", "Ida Tarbell", "Lincoln Steffens"], answerIndex: 0 },
  { type: "mc", prompt: "Upton Sinclair\u2019s novel that exposed the meatpacking industry was titled ______.", options: ["The Octopus", "How the Other Half Lives", "The Jungle", "The Shame of the Cities"], answerIndex: 2 },
  { type: "mc", prompt: "Ida M. Tarbell wrote an expos\u00e9 on which company\u2019s cutthroat methods?", options: ["U.S. Steel", "Standard Oil Company", "American Tobacco", "Northern Securities"], answerIndex: 1 },
  { type: "tf", prompt: "Thomas Nast was known for political cartoons attacking corruption.", answer: true },
  { type: "mc", prompt: "The 'Brandeis Brief' emphasized what in legal arguments?", options: ["Personal attacks", "Lengthy rhetoric", "Data from social scientists on costs", "Religious morality"], answerIndex: 2 },
  { type: "mc", prompt: "Which industrialist revolutionized auto production with the assembly line and paid $5/day for 8\u2011hour shifts?", options: ["Andrew Carnegie", "Henry Ford", "J.P. Morgan", "Cornelius Vanderbilt"], answerIndex: 1 },
  { type: "mc", prompt: "After the 1900 Galveston hurricane, the city adopted what form of government?", options: ["Strong mayor", "Commission (five\u2011member)", "Direct democracy", "Military rule"], answerIndex: 1 },
  { type: "mc", prompt: "Dayton, Ohio\u2019s flood in 1913 led to the spread of which model?", options: ["Council\u2011manager form", "Town meeting", "Parish police jury", "Unicameral legislature"], answerIndex: 0 },
  { type: "mc", prompt: "Which reform mayor of Detroit lowered fares and rooted out corruption?", options: ["Tom Johnson", "Hazen Pingree", "Fiorello LaGuardia", "Samuel Jones"], answerIndex: 1 },
  { type: "mc", prompt: "Tom Johnson, mayor of Cleveland, was unusual because he was a ______.", options: ["Socialist reformer", "Railroad magnate", "Federal judge", "Former president"], answerIndex: 0 },
  { type: "mc", prompt: "Robert 'Fighting Bob' La Follette was governor of which state?", options: ["Ohio", "Wisconsin", "Illinois", "New York"], answerIndex: 1 },
  { type: "mc", prompt: "The 'Wisconsin Idea' involved recruiting professors to help write laws and provide expert advice so that government would be controlled by ______.", options: ["Business leaders", "Voters rather than business", "Party bosses", "The courts"], answerIndex: 1 },
  { type: "mc", prompt: "Which is the correct pairing of reform and definition?", options: ["Initiative \u2014 vote on a bill already passed", "Referendum \u2014 bill originated by the people", "Recall \u2014 remove officials by forcing a new election", "Primary \u2014 appoint candidates by party leaders"], answerIndex: 2 },
  { type: "mc", prompt: "Which amendment provided for the direct election of U.S. senators?", options: ["16th", "17th", "18th", "19th"], answerIndex: 1 },
  { type: "mc", prompt: "The Keating\u2013Owen Act of 1916 sought to restrict ______.", options: ["Railroad rebates", "Child labor by banning interstate shipment of goods made by children", "Immigration from Europe", "Working on Sundays"], answerIndex: 1 },
  { type: "mc", prompt: "In Muller v. Oregon (1908), the Supreme Court upheld ______.", options: ["A 10\u2011hour workday for women", "The 8\u2011hour day for all workers", "Child labor nationwide", "Company scrip payments"], answerIndex: 0 },
  { type: "mc", prompt: "Bunting v. Oregon (1917) extended which reform?", options: ["10\u2011hour day to men", "Right to unionize", "Minimum wage", "Safety inspections"], answerIndex: 0 },
  { type: "tf", prompt: "Secret ballots, initiative, referendum, and recall were part of election reforms that made politicians more accountable to the people.", answer: true },
  { type: "mc", prompt: "Which devices were used in the South to restrict African American voting?", options: ["Property taxes only", "Literacy tests and poll taxes", "Open primaries", "Citizenship exams for all"], answerIndex: 1 },
  { type: "mc", prompt: "The 'grandfather clause' allowed voting if a man or his ancestor could vote before which date?", options: ["July 4, 1776", "January 1, 1867", "January 1, 1900", "December 7, 1787"], answerIndex: 1 },
  { type: "mc", prompt: "De jure segregation refers to segregation ______.", options: ["By custom and practice", "Required by laws (Jim Crow)", "By economic class only", "Only in schools"], answerIndex: 1 },
  { type: "mc", prompt: "'Separate but equal' was established by which 1896 Supreme Court case?", options: ["Brown v. Board", "Plessy v. Ferguson", "Sweatt v. Painter", "Williams v. Mississippi"], answerIndex: 1 },
  { type: "mc", prompt: "Which reformers advocated different strategies: moderate uplift vs. urgent full equality?", options: ["Gompers vs. Debs", "Washington vs. Du Bois", "La Follette vs. Wilson", "Carnegie vs. Rockefeller"], answerIndex: 1 },
  { type: "mc", prompt: "Ida B. Wells was known primarily for ______.", options: ["Exposing meatpacking", "Leading the WCTU", "Documenting lynching and editing the Free Speech and Headlight", "Writing The Shame of the Cities"], answerIndex: 2 },
  { type: "tf", prompt: "The Wilmington Race Riots involved white radicals attacking African Americans after Democrats took control of North Carolina in 1898.", answer: true },
  { type: "mc", prompt: "United States v. Wong Kim Ark helped determine what?", options: ["Limitations on free speech", "Citizenship for children of immigrants born in the U.S.", "Legal drinking age", "Voting age to 18"], answerIndex: 1 },
  { type: "mc", prompt: "The Dawes Act of 1887 allowed Native Americans to ______.", options: ["Form labor unions", "Trade reservation land for citizenship (though full rights were still limited)", "Vote in federal elections immediately", "Serve on juries"], answerIndex: 1 },
  { type: "mc", prompt: "The Ghost Dance movement encouraged Native Americans to ______.", options: ["Assimilate quickly", "Return to traditions; later banned by the Bureau of Indian Affairs", "Move to cities", "Adopt Christianity"], answerIndex: 1 },
  { type: "mc", prompt: "By 1890, women high\u2011school graduates outnumbered men and began filling jobs especially in ______.", options: ["Mining and logging", "Offices, stores, and classrooms", "Steel mills", "Railroads"], answerIndex: 1 },
  { type: "mc", prompt: "Married Women\u2019s Property Acts allowed women to ______.", options: ["Hold office", "Serve on juries", "Own property in their own name and keep wages", "Vote in federal elections"], answerIndex: 2 },
  { type: "mc", prompt: "Which organization formed in 1896 managed nurseries, reading rooms, and kindergartens?", options: ["NAWSA", "NACW (National Association of Colored Women)", "AFL", "WCTU"], answerIndex: 1 },
  { type: "mc", prompt: "Susan B. Anthony did NOT support which after 1869, according to the notes?", options: ["14th and 15th Amendments as written", "Women\u2019s suffrage", "National organization for suffrage", "Court cases to test rights"], answerIndex: 0 },
  { type: "mc", prompt: "NAWSA leaders included all EXCEPT which person?", options: ["Lucy Stone", "Julia Ward Howe", "Carrie Chapman Catt", "Eugene V. Debs"], answerIndex: 3 },
  { type: "mc", prompt: "One prong of the three\u2011part strategy for suffrage was to ______.", options: ["Persuade Congress only", "Convince state legislatures to grant voting rights", "End all protests", "Focus on courts exclusively"], answerIndex: 1 },
  { type: "mc", prompt: "Anti\u2011suffrage arguments in the notes included claims that women were ______.", options: ["Over\u2011educated for politics", "Too frail or interfering with the home", "More competent than men", "Required to vote"], answerIndex: 1 },
  { type: "mc", prompt: "Roosevelt earned the title 'trust\u2011buster' partly after which case?", options: ["Plessy v. Ferguson", "Northern Securities Co. v. U.S. (1904)", "Munn v. Illinois", "Lochner v. New York"], answerIndex: 1 },
  { type: "mc", prompt: "During the 1902 coal strike, the federal government ______.", options: ["Always sided with owners and sent troops only", "Intervened and used arbitration to settle with a raise and 9\u2011hour day", "Jailed union leaders for sedition", "Ignored the strike"], answerIndex: 1 },
  { type: "mc", prompt: "Which acts strengthened railroad regulation?", options: ["Elkins Act (1903) and Hepburn Act (1906)", "Wagner Act and Taft\u2011Hartley", "Clayton Act and FTC Act", "Keating\u2013Owen and Smith\u2011Lever"], answerIndex: 0 },
  { type: "mc", prompt: "The Meat Inspection Act of 1906 followed public outcry after ______.", options: ["The Octopus", "The Jungle", "The Shame of the Cities", "How the Other Half Lives"], answerIndex: 1 },
  { type: "mc", prompt: "The Pure Food and Drug Act of 1906 required ______.", options: ["Tariff cuts", "Truth in labeling and halted sale of contaminated products", "Eight\u2011hour workday", "Women\u2019s suffrage"], answerIndex: 1 },
  { type: "mc", prompt: "Roosevelt\u2019s conservation efforts included setting aside approximately ______ of forest and other resources.", options: ["14.8 million acres", "148 million acres of forest (plus other reserves)", "48 thousand acres", "1.5 thousand acres"], answerIndex: 1 },
  { type: "tf", prompt: "Gifford Pinchot, head of the U.S. Forest Service, advised conserving forests and grazing lands by exempting federal lands from private sale.", answer: true },
  { type: "mc", prompt: "Roosevelt\u2019s record on civil rights for African Americans was ______.", options: ["Strong and comprehensive", "Limited; he supported few measures and hosted a symbolic dinner with Booker T. Washington", "Nonexistent information", "Worse than Wilson\u2019s"], answerIndex: 1 },
  { type: "mc", prompt: "The Payne\u2011Aldrich Tariff under Taft is best described as a ______.", options: ["Major cut that pleased Progressives", "Compromise that moderated but kept high rates of the Aldrich bill", "Free\u2011trade pact with Europe", "Ban on child labor"], answerIndex: 1 },
  { type: "mc", prompt: "The Ballinger\u2011Pinchot controversy involved ______.", options: ["Prohibition enforcement", "Conservation policy and western lands", "Women\u2019s suffrage", "Income tax collection"], answerIndex: 1 },
  { type: "mc", prompt: "Which party formed by Progressives in 1912 supported direct election of senators, women\u2019s suffrage, and an 8\u2011hour workday?", options: ["Socialist Party", "Bull Moose (Progressive) Party", "Prohibition Party", "Dixiecrats"], answerIndex: 1 },
  { type: "mc", prompt: "Woodrow Wilson won the 1912 election with about what share of the popular vote?", options: ["60%", "42%", "25%", "50%"], answerIndex: 1 },
  { type: "mc", prompt: "Which law strengthened antitrust regulations by forbidding companies from buying competitors\u2019 stock if it created a monopoly?", options: ["Sherman Antitrust Act", "Clayton Antitrust Act of 1914", "Elkins Act", "Hepburn Act"], answerIndex: 1 },
  { type: "mc", prompt: "The Federal Trade Commission (1914) was empowered to ______.", options: ["Set railroad rates only", "Investigate possible violations of regulatory rules and issue cease\u2011and\u2011desist orders", "Print money", "Manage national parks"], answerIndex: 1 },
  { type: "mc", prompt: "The 16th Amendment (1913) established ______.", options: ["Direct election of senators", "A federal income tax", "Prohibition", "Women\u2019s suffrage"], answerIndex: 1 },
  { type: "mc", prompt: "The Federal Reserve Act of 1913 divided the nation into how many districts with regional banks?", options: ["5", "12", "20", "2"], answerIndex: 1 },
  { type: "mc", prompt: "Which amendment granted women the right to vote nationwide?", options: ["18th", "19th", "21st", "17th"], answerIndex: 1 },
  { type: "mc", prompt: "Carrie Chapman Catt emphasized which tactics in leading the national movement?", options: ["Violent protests", "Five\u2011part plan including organization, wide support, cautious lobbying, and ladylike behavior", "Abandoning state campaigns", "Only court cases"], answerIndex: 1 },
  { type: "mc", prompt: "Wilson\u2019s civil\u2011rights record included ______.", options: ["Desegregating the federal government", "Appointment of segregationists and a confrontation with William Monroe Trotter", "Support for anti\u2011lynching laws", "Hosting the Niagara Movement"], answerIndex: 1 },
  { type: "tf", prompt: "World War I helped end the Progressive Era as focus shifted away from domestic reform.", answer: true }
];

// Will hold active questions for this session run
let active = [];
let mode = "test"; // 'study' | 'test'
let idx = 0;
let given = {};    // idx -> selected index (for mc) or boolean (for tf)
let locked = {};   // idx -> true once answered in test mode
let score = 0;
let missed = [];
let countTarget = 50;

/** RENDER **/
function setMode(next) {
  mode = next;
  el("modePill").textContent = next === "study" ? "Study Mode" : "Test Mode";
}
function setCountFromSelect() {
  countTarget = parseInt(el("countSelect").value, 10);
}
function buildRun(from = QUESTION_BANK) {
  const pool = from.slice();
  shuffle(pool);
  active = pool.slice(0, Math.min(countTarget, pool.length)).map(q => {
    if (q.type === "mc") {
      const opts = q.options.slice();
      const answerText = opts[q.answerIndex];
      shuffle(opts);
      const newAnswerIndex = opts.indexOf(answerText);
      return { ...q, options: opts, answerIndex: newAnswerIndex };
    } else {
      return { ...q }; // tf unchanged
    }
  });
  idx = 0;
  given = {};
  locked = {};
  score = 0;
  missed = [];
  render();
}
function render() {
  // Progress
  const total = active.length;
  el("progressText").textContent = `${clamp(idx+1,0,total)}/${total}`;
  const pct = total ? ((idx)/total)*100 : 0;
  el("bar").style.width = `${pct}%`;

  // Question
  const q = active[idx];
  if (!q) {
    el("qText").textContent = "Tap Start to begin.";
    el("answers").innerHTML = "";
    el("feedback").style.display = "none";
    return;
  }
  el("qText").textContent = q.prompt;

  // Answers
  const answersDiv = el("answers");
  answersDiv.innerHTML = "";
  const fb = el("feedback");
  fb.style.display = "none";
  if (q.type === "mc") {
    q.options.forEach((opt, i) => {
      const id = `opt-${idx}-${i}`;
      const row = document.createElement("label");
      row.className = "choice";
      row.innerHTML = `
        <input type="radio" name="q-${idx}" id="${id}" value="${i}" ${given[idx]===i?"checked":""} />
        <div>${opt}</div>`;
      answersDiv.appendChild(row);
      row.addEventListener("click", (e) => {
        if (locked[idx]) return; // prevent changes after lock in test mode
        given[idx] = i;
        if (mode === "study") {
          const correct = i === q.answerIndex;
          fb.style.display = "block";
          fb.innerHTML = correct ? `<span class="ok">Correct!</span>` : `<span class="bad">Try again.</span>`;
        }
      });
    });
  } else if (q.type === "tf") {
    ["True","False"].forEach((opt, i) => {
      const val = (i === 0);
      const row = document.createElement("label");
      row.className = "choice";
      row.innerHTML = `
        <input type="radio" name="q-${idx}" value="${val}" ${given[idx]===val?"checked":""} />
        <div>${opt}</div>`;
      answersDiv.appendChild(row);
      row.addEventListener("click", () => {
        if (locked[idx]) return;
        given[idx] = val;
        if (mode === "study") {
          const correct = (val === q.answer);
          fb.style.display = "block";
          fb.innerHTML = correct ? `<span class="ok">Correct!</span>` : `<span class="bad">Try again.</span>`;
        }
      });
    });
  }

  // Nav buttons
  el("prevBtn").disabled = idx === 0;
  el("nextBtn").textContent = (idx === total - 1) ? (mode === "test" ? "Finish" : "Done") : "Next ▶︎";
}
function next() {
  const q = active[idx];
  if (!q) return;
  // In test mode, lock answer on Next
  if (mode === "test" && !locked[idx]) {
    locked[idx] = true;
    // grade if answered
    if (q.type === "mc" && typeof given[idx] === "number") {
      if (given[idx] === q.answerIndex) score++; else missed.push(idx);
    } else if (q.type === "tf" && typeof given[idx] === "boolean") {
      if (given[idx] === q.answer) score++; else missed.push(idx);
    } else {
      // unanswered counts as missed
      missed.push(idx);
    }
  }
  // Move forward or finish
  if (idx < active.length - 1) {
    idx++;
    render();
  } else {
    if (mode === "test") finish();
  }
}
function prev() {
  if (idx > 0) {
    idx--;
    render();
  }
}
function finish() {
  const total = active.length;
  const pct = total ? Math.round((score/total)*100) : 0;
  el("scoreLine").textContent = `Score: ${score}/${total} (${pct}%)`;
  // Build missed review
  if (missed.length) {
    el("missedWrap").style.display = "block";
    const list = el("missedList");
    list.innerHTML = "";
    missed.forEach(i => {
      const q = active[i];
      const card = document.createElement("div");
      card.className = "card";
      const userAnswer = given[i];
      let correctText = "";
      if (q.type === "mc") {
        correctText = q.options[q.answerIndex];
      } else {
        correctText = q.answer ? "True" : "False";
      }
      let yourText = "(no answer)";
      if (typeof userAnswer !== "undefined") {
        if (q.type === "mc") {
          yourText = q.options[userAnswer];
        } else {
          yourText = userAnswer ? "True" : "False";
        }
      }
      card.innerHTML = `
        <div style="font-weight:700; margin-bottom:6px;">${q.prompt}</div>
        <div class="tiny">Your answer: ${yourText}</div>
        <div class="tiny">Correct answer: <span class="ok">${correctText}</span></div>
      `;
      list.appendChild(card);
    });
  } else {
    el("missedWrap").style.display = "none";
  }
  el("summary").style.display = "block";
  // scroll to summary
  el("summary").scrollIntoView({ behavior: "smooth" });
}

function startRun() {
  setCountFromSelect();
  buildRun();
  el("summary").style.display = "none";
  render();
}

/** EVENTS **/
el("studyBtn").addEventListener("click", () => { setMode("study"); el("studyBtn").classList.add("primary"); el("testBtn").classList.remove("primary"); });
el("testBtn").addEventListener("click", () => { setMode("test"); el("testBtn").classList.add("primary"); el("studyBtn").classList.remove("primary"); });
el("startBtn").addEventListener("click", startRun);
el("nextBtn").addEventListener("click", next);
el("prevBtn").addEventListener("click", prev);
el("retryBtn").addEventListener("click", () => { startRun(); });
el("studyFromMissedBtn").addEventListener("click", () => {
  // Build a study-only pool from missed
  const pool = missed.map(i => active[i]);
  if (!pool.length) return;
  setMode("study");
  el("studyBtn").classList.add("primary"); el("testBtn").classList.remove("primary");
  // Slight shuffle for variety
  shuffle(pool);
  active = pool;
  idx = 0;
  given = {};
  locked = {};
  score = 0;
  missed = [];
  el("summary").style.display = "none";
  render();
});

/** DOWNLOAD CURRENT FILE **/
el("downloadBtn").addEventListener("click", () => {
  // Offer download of the exact HTML as currently opened
  const blob = new Blob([document.documentElement.outerHTML], { type: "text/html;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "practice_test.html";
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(url);
  a.remove();
});
</script>
</body>
</html>
